@page "/my-schedule"
@using AttendanceManagement.Interfaces
@using AttendanceManagement.Permissions
@using Volo.Abp.Users
@using Volo.Abp.AspNetCore.Components.Messages
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@attribute [Authorize(AttendanceManagementPermissions.Schedules.ViewOwn)]
@inject IScheduleAppService ScheduleAppService
@inject IEmployeeAppService EmployeeAppService
@inject ICurrentUser CurrentUser
@inject IUiMessageService MessageService
@inject IAuthorizationService AuthorizationService
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<AttendanceManagementResource> L
@inherits AbpComponentBase

<Card>
    <CardHeader>
        <Row Class="justify-content-between">
            <Column ColumnSize="ColumnSize.IsAuto">
                <h2>@L["MySchedule"]</h2>
            </Column>
            <Column ColumnSize="ColumnSize.IsAuto">
                @if (HasExportPermission && CurrentSchedule != null)
                {
                    <Button Color="Color.Success" Clicked="@ExportScheduleAsync">
                        <Icon Name="IconName.FileDownload" /> @L["ExportToExcel"]
                    </Button>
                }
            </Column>
        </Row>
    </CardHeader>
    <CardBody>
        @if (IsLoading)
        {
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (CurrentSchedule != null)
        {
            <Row>
                <Column>
                    <Alert Color="Color.Info" Visible="true">
                        <AlertDescription>
                            <strong>@L["ScheduleName"]:</strong> @CurrentSchedule.ScheduleName<br />
                            <strong>@L["SeatNumber"]:</strong> @CurrentSchedule.SeatNumber<br />
                            <strong>@L["Floor"]:</strong> @CurrentSchedule.FloorNumber
                        </AlertDescription>
                    </Alert>
                </Column>
            </Row>

            <Row Margin="Margin.Is3.FromTop">
                <Column>
                    <h4>@L["WeeklySchedule"]</h4>

                    @* Calendar View *@
                    <Row Gutter="(16, 16)">
                        @foreach (var day in ScheduleDays.OrderBy(d => d.DayOfWeek))
                        {
                            var isToday = day.DayOfWeek == DateTime.Now.DayOfWeek;
                            <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnTablet.Is3.OnDesktop">
                                <Card Border="@(isToday? Border.Is3.Primary : Border.Is1.Light)"
                                      Background="@(day.IsOnSite ? Background.Primary : Background.Light)">
                                    <CardBody TextColor="@(day.IsOnSite? TextColor.White: TextColor.Dark)"
                                              TextAlignment="TextAlignment.Center">
                                        <Heading Size="HeadingSize.Is5"
                                                 TextColor="@(day.IsOnSite ? TextColor.White : TextColor.Dark)">
                                            @day.DayOfWeek.ToString()
                                        </Heading>
                                        @if (isToday)
                                        {
                                            <Badge Color="Color.Warning">@L["Today"]</Badge>
                                        }
                                        <Divider />
                                        @if (day.IsOnSite)
                                        {
                                            <Icon Name="IconName.Building" IconSize="IconSize.x3" />
                                            <Paragraph Margin="Margin.Is1.FromTop">
                                                @L["OnSite"]
                                            </Paragraph>
                                            <Small>@CurrentSchedule.SeatNumber</Small>
                                        }
                                        else
                                        {
                                            <Icon Name="IconName.Home" IconSize="IconSize.x3" />
                                            <Paragraph Margin="Margin.Is1.FromTop">
                                                @L["WorkFromHome"]
                                            </Paragraph>
                                        }
                                    </CardBody>
                                </Card>
                            </Column>
                        }
                    </Row>

                    @* List View *@
                    <Divider />
                    <Table Striped="true" Hoverable="true" Margin="Margin.Is3.FromTop">
                        <TableHeader ThemeContrast="ThemeContrast.Dark">
                            <TableRow>
                                <TableHeaderCell>@L["Day"]</TableHeaderCell>
                                <TableHeaderCell>@L["WorkLocation"]</TableHeaderCell>
                                <TableHeaderCell>@L["Seat"]</TableHeaderCell>
                                <TableHeaderCell>@L["Floor"]</TableHeaderCell>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            @foreach (var day in ScheduleDays.OrderBy(d => d.DayOfWeek))
                            {
                                var isToday = day.DayOfWeek == DateTime.Now.DayOfWeek;
                                <TableRow Background="@(isToday? Background.Light: Background.Default)">
                                    <TableRowCell>
                                        <strong>@day.DayOfWeek.ToString()</strong>
                                        @if (isToday)
                                        {
                                            <Badge Color="Color.Warning" Margin="Margin.Is1.FromStart">@L["Today"]</Badge>
                                        }
                                    </TableRowCell>
                                    <TableRowCell>
                                        @if (day.IsOnSite)
                                        {
                                            <Badge Color="Color.Primary">
                                                <Icon Name="IconName.Building" /> @L["OnSite"]
                                            </Badge>
                                        }
                                        else
                                        {
                                            <Badge Color="Color.Info">
                                                <Icon Name="IconName.Home" /> @L["Remote"]
                                            </Badge>
                                        }
                                    </TableRowCell>
                                    <TableRowCell>
                                        @if (day.IsOnSite)
                                        {
                                            @CurrentSchedule.SeatNumber
                                        }
                                        else
                                        {
                                            <Text>-</Text>
                                        }
                                    </TableRowCell>
                                    <TableRowCell>
                                        @if (day.IsOnSite)
                                        {
                                            @CurrentSchedule.FloorNumber
                                        }
                                        else
                                        {
                                            <Text>-</Text>
                                        }
                                    </TableRowCell>
                                </TableRow>
                            }
                        </TableBody>
                    </Table>
                </Column>
            </Row>
        }
        else
        {
            <Alert Color="Color.Warning" Visible="true">
                <AlertDescription>
                    @L["NoScheduleAssigned"]
                </AlertDescription>
            </Alert>
        }
    </CardBody>
</Card>

@code {
    private ScheduleAssignmentDto CurrentSchedule { get; set; }
    private List<ScheduleDayDto> ScheduleDays { get; set; } = new();
    private bool HasExportPermission { get; set; }
    private bool IsLoading { get; set; } = true;
    private Guid? CurrentEmployeeId { get; set; }
    private bool _hasLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        if (_hasLoaded) return;
        _hasLoaded = true;
        try
        {
            HasExportPermission = await AuthorizationService.IsGrantedAsync(
                AttendanceManagementPermissions.Schedules.Export);
            await LoadMyScheduleAsync();
        }
        catch (Exception ex)
        {
            await MessageService.Error(L["ErrorLoadingSchedule"] + ": " + ex.Message);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadMyScheduleAsync()
    {
        try
        {
            if (!CurrentUser.Id.HasValue)
            {
                await MessageService.Error(L["UserNotAuthenticated"]);
                return;
            }

            // Get all employees and find current user's employee record
            var allEmployees = await EmployeeAppService.GetActiveEmployeesAsync();
            var currentEmployee = allEmployees.FirstOrDefault(e => e.UserId == CurrentUser.Id.Value);

            if (currentEmployee == null)
            {
                await MessageService.Info(L["EmployeeRecordNotFound"]);
                return;
            }

            CurrentEmployeeId = currentEmployee.Id;

            // Get current schedule assignment
            CurrentSchedule = await ScheduleAppService.GetEmployeeCurrentScheduleAsync(currentEmployee.Id);

            if (CurrentSchedule != null)
            {
                // Get schedule details with days
                var schedule = await ScheduleAppService.GetAsync(CurrentSchedule.ScheduleId);
                ScheduleDays = schedule.ScheduleDays.ToList();
            }
        }
        catch (Exception ex)
        {
            await MessageService.Error(L["ErrorLoadingSchedule"] + ": " + ex.Message);
        }
    }

    private async Task ExportScheduleAsync()
    {
        try
        {
            if (!CurrentEmployeeId.HasValue)
            {
                await MessageService.Error(L["EmployeeRecordNotFound"]);
                return;
            }

            var fileBytes = await ScheduleAppService.ExportEmployeeScheduleAsync(CurrentEmployeeId.Value);

            // Download file
            var fileName = $"MySchedule_{DateTime.Now:yyyyMMdd}.xlsx";
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileBytes));

            await MessageService.Success(L["SuccessfullyExported"]);
        }
        catch (Exception ex)
        {
            await MessageService.Error(ex.Message);
        }
    }
}